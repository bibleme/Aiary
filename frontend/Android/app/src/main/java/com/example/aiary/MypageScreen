package com.example.aiary

import android.app.DatePickerDialog
import android.widget.DatePicker
import android.widget.Toast
import androidx.compose.foundation.Image
import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Edit
import androidx.compose.material.icons.filled.KeyboardArrowRight
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.layout.ContentScale
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.example.aiary.data.ChangePasswordRequest
import com.example.aiary.network.RetrofitClient
import java.util.Calendar
import kotlinx.coroutines.launch
import androidx.lifecycle.viewmodel.compose.viewModel

private val White = Color(0xFFFFFFFF)

@Composable
fun MyPageScreen(onLogout: () -> Unit,
                 viewModel: MypageViewModel = viewModel()) {
    // ìƒíƒœ ë³€ìˆ˜ë“¤ (ë‚˜ì¤‘ì—” ì„œë²„ì—ì„œ ë°›ì•„ì˜¨ ê°’ìœ¼ë¡œ ì´ˆê¸°í™”í•´ì•¼ í•¨)
    var babyName by remember { mutableStateOf("ì‹œìš°") }
    var babyBirthDate by remember { mutableStateOf("2024-01-01") }
    var babyGender by remember { mutableStateOf("ë‚¨ì•„") } // "ë‚¨ì•„" or "ì—¬ì•„"

    val context = LocalContext.current
    val scrollState = rememberScrollState()
    val coroutineScope = rememberCoroutineScope()

    // ë‹¬ë ¥ íŒì—… (DatePickerDialog)
    val calendar = Calendar.getInstance()
    val datePickerDialog = DatePickerDialog(
        context,
        { _: DatePicker, year: Int, month: Int, dayOfMonth: Int ->
            // ì›”ì€ 0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ +1 í•´ì¤Œ
            babyBirthDate = "$year-${month + 1}-$dayOfMonth"
        },
        2024, 0, 1 // ê¸°ë³¸ ì‹œì‘ ë‚ ì§œ
    )
    var showPasswordDialog by remember { mutableStateOf(false) }

    Column(
        modifier = Modifier
            .fillMaxSize()
            .background(BackgroundBeige)
            .padding(24.dp)
            .verticalScroll(scrollState),
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        // ìƒë‹¨ íƒ€ì´í‹€
        Text(
            text = "ë§ˆì´í˜ì´ì§€",
            fontSize = 24.sp,
            fontWeight = FontWeight.Bold,
            color = DarkGray,
            modifier = Modifier.padding(top = 16.dp, bottom = 32.dp)
        )

        // ì•„ì´ í”„ë¡œí•„ ì¹´ë“œ (ìˆ˜ì • ê°€ëŠ¥ ì˜ì—­)
        Card(
            colors = CardDefaults.cardColors(containerColor = White),
            elevation = CardDefaults.cardElevation(defaultElevation = 4.dp),
            shape = RoundedCornerShape(16.dp),
            modifier = Modifier.fillMaxWidth()
        ) {
            Column(
                modifier = Modifier.padding(24.dp),
                horizontalAlignment = Alignment.CenterHorizontally
            ) {
                // í”„ë¡œí•„ ì‚¬ì§„ (ì›í˜•)
                Box(
                    contentAlignment = Alignment.BottomEnd,
                    modifier = Modifier.size(100.dp)
                ) {
                    Image(
                        painter = painterResource(id = R.drawable.baby_icon), // ê¸°ë³¸ ì´ë¯¸ì§€
                        contentDescription = "í”„ë¡œí•„ ì‚¬ì§„",
                        contentScale = ContentScale.Crop,
                        modifier = Modifier
                            .fillMaxSize()
                            .clip(CircleShape)
                            .border(2.dp, PrimaryBlue, CircleShape)
                    )
                    // ìˆ˜ì • ì•„ì´ì½˜
                    Box(
                        modifier = Modifier
                            .size(30.dp)
                            .background(DarkGray, CircleShape)
                            .padding(6.dp)
                    ) {
                        Icon(Icons.Default.Edit, contentDescription = "ìˆ˜ì •", tint = White)
                    }
                }

                Spacer(modifier = Modifier.height(24.dp))

                // ì…ë ¥ í•„ë“œë“¤
                // ì´ë¦„ ì…ë ¥
                OutlinedTextField(
                    value = babyName,
                    onValueChange = { babyName = it },
                    label = { Text("ì•„ì´ ì´ë¦„(íƒœëª…)") },
                    singleLine = true,
                    modifier = Modifier.fillMaxWidth(),
                    colors = OutlinedTextFieldDefaults.colors(
                        focusedBorderColor = PrimaryBlue,
                        unfocusedBorderColor = Color.LightGray
                    )
                )

                Spacer(modifier = Modifier.height(16.dp))

                // ìƒë…„ì›”ì¼ ì„ íƒ (í´ë¦­í•˜ë©´ ë‹¬ë ¥ ëœ¸)
                OutlinedTextField(
                    value = babyBirthDate,
                    onValueChange = {},
                    label = { Text("ìƒë…„ì›”ì¼") },
                    readOnly = true,
                    trailingIcon = {
                        IconButton(onClick = { datePickerDialog.show() }) {
                            Icon(
                                painterResource(android.R.drawable.ic_menu_my_calendar),
                                contentDescription = "ë‹¬ë ¥"
                            )
                        }
                    },
                    modifier = Modifier
                        .fillMaxWidth()
                        .clickable { datePickerDialog.show() }, // í…ìŠ¤íŠ¸ í•„ë“œ ëˆŒëŸ¬ë„ ë‹¬ë ¥ ëœ¸
                    colors = OutlinedTextFieldDefaults.colors(
                        focusedBorderColor = PrimaryBlue,
                        unfocusedBorderColor = Color.LightGray
                    )
                )

                Spacer(modifier = Modifier.height(16.dp))

                // ì„±ë³„ ì„ íƒ (ë²„íŠ¼ 2ê°œ)
                Row(modifier = Modifier.fillMaxWidth()) {
                    GenderButton(
                        text = "ì™•ìë‹˜ ğŸ‘‘",
                        isSelected = babyGender == "ë‚¨ì•„",
                        onClick = { babyGender = "ë‚¨ì•„" },
                        modifier = Modifier.weight(1f)
                    )
                    Spacer(modifier = Modifier.width(8.dp))
                    GenderButton(
                        text = "ê³µì£¼ë‹˜ ğŸ€",
                        isSelected = babyGender == "ì—¬ì•„",
                        onClick = { babyGender = "ì—¬ì•„" },
                        modifier = Modifier.weight(1f)
                    )
                }

                Spacer(modifier = Modifier.height(24.dp))

                // ì €ì¥ ë²„íŠ¼
                Button(
                    onClick = {
                        // TODO: ì—¬ê¸°ì„œ ë°±ì—”ë“œë¡œ ìˆ˜ì •ëœ ì •ë³´ë¥¼ ë³´ë‚´ì•¼ í•¨ (PUT /users/profile)
                        Toast.makeText(context, "ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!", Toast.LENGTH_SHORT).show()
                    },
                    colors = ButtonDefaults.buttonColors(containerColor = PrimaryBlue),
                    modifier = Modifier.fillMaxWidth().height(50.dp),
                    shape = RoundedCornerShape(12.dp)
                ) {
                    Text("ì €ì¥í•˜ê¸°", fontWeight = FontWeight.Bold, fontSize = 16.sp)
                }
            }
        }

        Spacer(modifier = Modifier.height(24.dp))

        // ê³„ì • ì„¤ì •
        Text(
            text = "ê³„ì • ì„¤ì •",
            fontSize = 16.sp,
            fontWeight = FontWeight.Bold,
            color = Color.Gray,
            modifier = Modifier.align(Alignment.Start).padding(bottom = 8.dp)
        )

        Card(
            colors = CardDefaults.cardColors(containerColor = White),
            shape = RoundedCornerShape(12.dp),
            modifier = Modifier.fillMaxWidth()
        ) {
            Column {
                SettingItem(title = "ì´ë©”ì¼ ì •ë³´", value = "aiary@naver.com") // ë¡œê·¸ì¸ëœ ì´ë©”ì¼ í‘œì‹œ
                HorizontalDivider(color = BackgroundBeige)
                SettingItem(title = "ë¹„ë°€ë²ˆí˜¸ ë³€ê²½", isArrow = true, onClick = { showPasswordDialog = true })
                HorizontalDivider(color = BackgroundBeige)
                SettingItem(title = "ë¡œê·¸ì•„ì›ƒ", isArrow = true, onClick = onLogout, textColor = Color.Red)
            }
        }

        Spacer(modifier = Modifier.height(50.dp)) // í•˜ë‹¨ ì—¬ë°±

    }
    if (showPasswordDialog){
        ChangePasswordDialog(
            onDismiss = { showPasswordDialog = false },
            onConfirm = { currentPw, newPw ->
                // ë³µì¡í•œ ì½”ë“œëŠ” ë‹¤ ì§€ìš°ê³ , ë”± ì´ í•œ ì¤„ë¡œ ëëƒ…ë‹ˆë‹¤!
                viewModel.changePassword(context, currentPw, newPw)

                // ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸°
                showPasswordDialog = false
            }
        )
    }
}

// --- ë³´ì¡° ì»´í¬ì €ë¸” í•¨ìˆ˜ë“¤ ---

@Composable
fun GenderButton(
    text: String,
    isSelected: Boolean,
    onClick: () -> Unit,
    modifier: Modifier = Modifier
) {
    OutlinedButton(
        onClick = onClick,
        modifier = modifier.height(50.dp),
        shape = RoundedCornerShape(12.dp),
        border = if (isSelected) null else androidx.compose.foundation.BorderStroke(1.dp, Color.LightGray),
        colors = ButtonDefaults.outlinedButtonColors(
            containerColor = if (isSelected) PrimaryBlue.copy(alpha = 0.2f) else Color.Transparent,
            contentColor = if (isSelected) PrimaryBlue else Color.Gray
        )
    ) {
        Text(text, fontWeight = if (isSelected) FontWeight.Bold else FontWeight.Normal)
    }
}

@Composable
fun SettingItem(
    title: String,
    value: String = "",
    isArrow: Boolean = false,
    textColor: Color = DarkGray,
    onClick: () -> Unit = {}
) {
    Row(
        modifier = Modifier
            .fillMaxWidth()
            .clickable(enabled = isArrow || onClick != {}) { onClick() }
            .padding(16.dp),
        verticalAlignment = Alignment.CenterVertically,
        horizontalArrangement = Arrangement.SpaceBetween
    ) {
        Text(text = title, fontSize = 16.sp, color = textColor)
        Row(verticalAlignment = Alignment.CenterVertically) {
            if (value.isNotEmpty()) {
                Text(text = value, fontSize = 14.sp, color = Color.Gray)
            }
            if (isArrow) {
                Icon(Icons.Default.KeyboardArrowRight, contentDescription = null, tint = Color.Gray)
            }
        }
    }
}

@Composable
fun ChangePasswordDialog(
    onDismiss: () -> Unit,
    onConfirm: (String, String) -> Unit
) {
    var currentPassword by remember { mutableStateOf("") }
    var newPassword by remember { mutableStateOf("") }
    var confirmNewPassword by remember { mutableStateOf("") }
    var errorMessage by remember { mutableStateOf("") }

    AlertDialog(
        onDismissRequest = onDismiss,
        containerColor = Color.White, // ë°°ê²½ìƒ‰ í°ìƒ‰
        title = {
            Text(text = "ë¹„ë°€ë²ˆí˜¸ ë³€ê²½", fontWeight = FontWeight.Bold, fontSize = 18.sp)
        },
        text = {
            Column {
                OutlinedTextField(
                    value = currentPassword,
                    onValueChange = { currentPassword = it },
                    label = { Text("í˜„ì¬ ë¹„ë°€ë²ˆí˜¸") },
                    singleLine = true,
                    // ë¹„ë°€ë²ˆí˜¸ ê°€ë¦¬ê¸° ì„¤ì •
                    visualTransformation = androidx.compose.ui.text.input.PasswordVisualTransformation(),
                    colors = OutlinedTextFieldDefaults.colors(
                        focusedContainerColor = Color.White,
                        unfocusedContainerColor = Color.White,
                        focusedBorderColor = PrimaryBlue,
                        unfocusedBorderColor = Color.LightGray
                    ),
                    modifier = Modifier.fillMaxWidth()
                )
                Spacer(modifier = Modifier.height(8.dp))
                OutlinedTextField(
                    value = newPassword,
                    onValueChange = { newPassword = it },
                    label = { Text("ìƒˆ ë¹„ë°€ë²ˆí˜¸ (6ìë¦¬ ì´ìƒ)") },
                    singleLine = true,
                    visualTransformation = androidx.compose.ui.text.input.PasswordVisualTransformation(),
                    colors = OutlinedTextFieldDefaults.colors(
                        focusedContainerColor = Color.White,
                        unfocusedContainerColor = Color.White,
                        focusedBorderColor = PrimaryBlue,
                        unfocusedBorderColor = Color.LightGray
                    ),
                    modifier = Modifier.fillMaxWidth()
                )
                Spacer(modifier = Modifier.height(8.dp))
                OutlinedTextField(
                    value = confirmNewPassword,
                    onValueChange = { confirmNewPassword = it },
                    label = { Text("ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸") },
                    singleLine = true,
                    visualTransformation = androidx.compose.ui.text.input.PasswordVisualTransformation(),
                    colors = OutlinedTextFieldDefaults.colors(
                        focusedContainerColor = Color.White,
                        unfocusedContainerColor = Color.White,
                        focusedBorderColor = PrimaryBlue,
                        unfocusedBorderColor = Color.LightGray
                    ),
                    modifier = Modifier.fillMaxWidth()
                )

                // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                if (errorMessage.isNotEmpty()) {
                    Spacer(modifier = Modifier.height(8.dp))
                    Text(text = errorMessage, color = Color.Red, fontSize = 12.sp)
                }
            }
        },
        confirmButton = {
            Button(
                onClick = {
                    // ìœ íš¨ì„± ê²€ì‚¬
                    if (currentPassword.isEmpty() || newPassword.isEmpty()) {
                        errorMessage = "ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."
                    } else if (newPassword.length < 6) {
                        errorMessage = "ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” 6ìë¦¬ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤."
                    } else if (newPassword != confirmNewPassword) {
                        errorMessage = "ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
                    } else {
                        // ê²€ì‚¬ í†µê³¼ ì‹œ
                        onConfirm(currentPassword, newPassword)
                    }
                },
                colors = ButtonDefaults.buttonColors(containerColor = PrimaryBlue),
                shape = RoundedCornerShape(8.dp)
            ) {
                Text("ë³€ê²½")
            }
        },
        dismissButton = {
            TextButton(onClick = onDismiss) {
                Text("ì·¨ì†Œ", color = Color.Gray)
            }
        },
        shape = RoundedCornerShape(16.dp)
    )
}
